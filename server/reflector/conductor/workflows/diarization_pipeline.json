{
  "name": "diarization_pipeline",
  "description": "Reflector multitrack diarization pipeline",
  "version": 1,
  "schemaVersion": 2,
  "inputParameters": [
    "recording_id",
    "room_name",
    "tracks",
    "bucket_name",
    "transcript_id",
    "room_id"
  ],
  "tasks": [
    {
      "name": "get_recording",
      "taskReferenceName": "get_recording",
      "type": "SIMPLE",
      "inputParameters": {
        "recording_id": "${workflow.input.recording_id}",
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "get_participants",
      "taskReferenceName": "get_participants",
      "type": "SIMPLE",
      "inputParameters": {
        "mtg_session_id": "${get_recording.output.mtg_session_id}",
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "generate_dynamic_fork_tasks",
      "taskReferenceName": "generate_padding_tasks",
      "type": "SIMPLE",
      "inputParameters": {
        "tracks": "${workflow.input.tracks}",
        "task_type": "pad_track",
        "transcript_id": "${workflow.input.transcript_id}",
        "bucket_name": "${workflow.input.bucket_name}"
      }
    },
    {
      "name": "fork_track_padding",
      "taskReferenceName": "fork_track_padding",
      "type": "FORK_JOIN_DYNAMIC",
      "inputParameters": {
        "dynamicTasks": "${generate_padding_tasks.output.tasks}",
        "dynamicTasksInput": "${generate_padding_tasks.output.inputs}"
      },
      "dynamicForkTasksParam": "dynamicTasks",
      "dynamicForkTasksInputParamName": "dynamicTasksInput"
    },
    {
      "name": "join_padding",
      "taskReferenceName": "join_padding",
      "type": "JOIN"
    },
    {
      "name": "mixdown_tracks",
      "taskReferenceName": "mixdown_tracks",
      "type": "SIMPLE",
      "inputParameters": {
        "padded_urls": "${join_padding.output..padded_url}",
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "generate_waveform",
      "taskReferenceName": "generate_waveform",
      "type": "SIMPLE",
      "inputParameters": {
        "audio_key": "${mixdown_tracks.output.audio_key}",
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "generate_dynamic_fork_tasks",
      "taskReferenceName": "generate_transcription_tasks",
      "type": "SIMPLE",
      "inputParameters": {
        "tracks": "${workflow.input.tracks}",
        "task_type": "transcribe_track",
        "transcript_id": "${workflow.input.transcript_id}",
        "padded_urls": "${join_padding.output}"
      }
    },
    {
      "name": "fork_transcription",
      "taskReferenceName": "fork_transcription",
      "type": "FORK_JOIN_DYNAMIC",
      "inputParameters": {
        "dynamicTasks": "${generate_transcription_tasks.output.tasks}",
        "dynamicTasksInput": "${generate_transcription_tasks.output.inputs}"
      },
      "dynamicForkTasksParam": "dynamicTasks",
      "dynamicForkTasksInputParamName": "dynamicTasksInput"
    },
    {
      "name": "join_transcription",
      "taskReferenceName": "join_transcription",
      "type": "JOIN"
    },
    {
      "name": "merge_transcripts",
      "taskReferenceName": "merge_transcripts",
      "type": "SIMPLE",
      "inputParameters": {
        "transcripts": "${join_transcription.output}",
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "detect_topics",
      "taskReferenceName": "detect_topics",
      "type": "SIMPLE",
      "inputParameters": {
        "words": "${merge_transcripts.output.all_words}",
        "transcript_id": "${workflow.input.transcript_id}",
        "target_language": "en"
      }
    },
    {
      "name": "fork_generation",
      "taskReferenceName": "fork_generation",
      "type": "FORK_JOIN",
      "forkTasks": [
        [
          {
            "name": "generate_title",
            "taskReferenceName": "generate_title",
            "type": "SIMPLE",
            "inputParameters": {
              "topics": "${detect_topics.output.topics}",
              "transcript_id": "${workflow.input.transcript_id}"
            }
          }
        ],
        [
          {
            "name": "generate_summary",
            "taskReferenceName": "generate_summary",
            "type": "SIMPLE",
            "inputParameters": {
              "words": "${merge_transcripts.output.all_words}",
              "topics": "${detect_topics.output.topics}",
              "transcript_id": "${workflow.input.transcript_id}"
            }
          }
        ]
      ]
    },
    {
      "name": "join_generation",
      "taskReferenceName": "join_generation",
      "type": "JOIN",
      "joinOn": ["generate_title", "generate_summary"]
    },
    {
      "name": "finalize",
      "taskReferenceName": "finalize",
      "type": "SIMPLE",
      "inputParameters": {
        "transcript_id": "${workflow.input.transcript_id}",
        "title": "${generate_title.output.title}",
        "summary": "${generate_summary.output.summary}",
        "short_summary": "${generate_summary.output.short_summary}",
        "duration": "${mixdown_tracks.output.duration}"
      }
    },
    {
      "name": "cleanup_consent",
      "taskReferenceName": "cleanup_consent",
      "type": "SIMPLE",
      "inputParameters": {
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "post_zulip",
      "taskReferenceName": "post_zulip",
      "type": "SIMPLE",
      "inputParameters": {
        "transcript_id": "${workflow.input.transcript_id}"
      }
    },
    {
      "name": "send_webhook",
      "taskReferenceName": "send_webhook",
      "type": "SIMPLE",
      "inputParameters": {
        "transcript_id": "${workflow.input.transcript_id}",
        "room_id": "${workflow.input.room_id}"
      }
    }
  ],
  "outputParameters": {
    "transcript_id": "${workflow.input.transcript_id}",
    "title": "${generate_title.output.title}",
    "summary": "${generate_summary.output.summary}",
    "duration": "${mixdown_tracks.output.duration}",
    "word_count": "${merge_transcripts.output.word_count}"
  }
}
